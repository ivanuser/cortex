import{G,H as me,aq as oe,x as k,N as K,P as ye,ak as Te,g as S,al as ke,an as Se,ao as Z,M as z,O as x,K as Ce,ar as be,as as ee,z as Ee,at as C,ah as W,au as Ae,aj as Ie,a6 as Ne,B as Me,av as V,aw as De,ax as Re,_ as Oe,ay as te,az as He,ae as ce,ag as le,aA as $,w as ue,aB as Fe,aC as Le,aD as Pe,af as xe,L as Ue,aE as qe,aF as Ge,aG as Ke,aH as ze,aI as de,aJ as $e,s as q,a as je,d as m}from"./qR_TM3YX.js";import{_ as ne}from"./DpBBTLWw.js";function lt(t,e){return e}function We(t,e,n){for(var i=[],s=e.length,o,a=e.length,d=0;d<s;d++){let v=e[d];le(v,()=>{if(o){if(o.pending.delete(v),o.done.add(v),o.pending.size===0){var h=t.outrogroups;B(V(o.done)),h.delete(o),h.size===0&&(t.outrogroups=null)}}else a-=1},!1)}if(a===0){var c=i.length===0&&n!==null;if(c){var f=n,l=f.parentNode;Pe(l),l.append(f),t.items.clear()}B(e,!c)}else o={pending:new Set(e),done:new Set},(t.outrogroups??=new Set).add(o)}function B(t,e=!0){for(var n=0;n<t.length;n++)xe(t[n],e)}var ie;function ut(t,e,n,i,s,o=null){var a=t,d=new Map,c=(e&oe)!==0;if(c){var f=t;a=k?K(ye(f)):f.appendChild(G())}k&&Te();var l=null,v=Ne(()=>{var u=n();return Me(u)?u:u==null?[]:V(u)}),h,p=!0;function T(){r.fallback=l,Be(r,h,a,e,i),l!==null&&(h.length===0?(l.f&C)===0?ce(l):(l.f^=C,L(l,null,a)):le(l,()=>{l=null}))}var b=me(()=>{h=S(v);var u=h.length;let E=!1;if(k){var A=ke(a)===Se;A!==(u===0)&&(a=Z(),K(a),z(!1),E=!0)}for(var w=new Set,N=Ee,D=Ie(),_=0;_<u;_+=1){k&&x.nodeType===Ce&&x.data===be&&(a=x,E=!0,z(!1));var M=h[_],R=i(M,_),g=p?null:d.get(R);g?(g.v&&ee(g.v,M),g.i&&ee(g.i,_),D&&N.unskip_effect(g.e)):(g=Je(d,p?a:ie??=G(),M,R,_,s,e,n),p||(g.e.f|=C),d.set(R,g)),w.add(R)}if(u===0&&o&&!l&&(p?l=W(()=>o(a)):(l=W(()=>o(ie??=G())),l.f|=C)),u>w.size&&Ae(),k&&u>0&&K(Z()),!p)if(D){for(const[we,_e]of d)w.has(we)||N.skip_effect(_e.e);N.oncommit(T),N.ondiscard(()=>{})}else T();E&&z(!0),S(v)}),r={effect:b,items:d,outrogroups:null,fallback:l};p=!1,k&&(a=x)}function F(t){for(;t!==null&&(t.f&Fe)===0;)t=t.next;return t}function Be(t,e,n,i,s){var o=(i&Le)!==0,a=e.length,d=t.items,c=F(t.effect.first),f,l=null,v,h=[],p=[],T,b,r,u;if(o)for(u=0;u<a;u+=1)T=e[u],b=s(T,u),r=d.get(b).e,(r.f&C)===0&&(r.nodes?.a?.measure(),(v??=new Set).add(r));for(u=0;u<a;u+=1){if(T=e[u],b=s(T,u),r=d.get(b).e,t.outrogroups!==null)for(const g of t.outrogroups)g.pending.delete(r),g.done.delete(r);if((r.f&C)!==0)if(r.f^=C,r===c)L(r,null,n);else{var E=l?l.next:c;r===t.effect.last&&(t.effect.last=r.prev),r.prev&&(r.prev.next=r.next),r.next&&(r.next.prev=r.prev),I(t,l,r),I(t,r,E),L(r,E,n),l=r,h=[],p=[],c=F(l.next);continue}if((r.f&$)!==0&&(ce(r),o&&(r.nodes?.a?.unfix(),(v??=new Set).delete(r))),r!==c){if(f!==void 0&&f.has(r)){if(h.length<p.length){var A=p[0],w;l=A.prev;var N=h[0],D=h[h.length-1];for(w=0;w<h.length;w+=1)L(h[w],A,n);for(w=0;w<p.length;w+=1)f.delete(p[w]);I(t,N.prev,D.next),I(t,l,N),I(t,D,A),c=A,l=D,u-=1,h=[],p=[]}else f.delete(r),L(r,c,n),I(t,r.prev,r.next),I(t,r,l===null?t.effect.first:l.next),I(t,l,r),l=r;continue}for(h=[],p=[];c!==null&&c!==r;)(f??=new Set).add(c),p.push(c),c=F(c.next);if(c===null)continue}(r.f&C)===0&&h.push(r),l=r,c=F(r.next)}if(t.outrogroups!==null){for(const g of t.outrogroups)g.pending.size===0&&(B(V(g.done)),t.outrogroups?.delete(g));t.outrogroups.size===0&&(t.outrogroups=null)}if(c!==null||f!==void 0){var _=[];if(f!==void 0)for(r of f)(r.f&$)===0&&_.push(r);for(;c!==null;)(c.f&$)===0&&c!==t.fallback&&_.push(c),c=F(c.next);var M=_.length;if(M>0){var R=(i&oe)!==0&&a===0?n:null;if(o){for(u=0;u<M;u+=1)_[u].nodes?.a?.measure();for(u=0;u<M;u+=1)_[u].nodes?.a?.fix()}We(t,_,R)}}o&&ue(()=>{if(v!==void 0)for(r of v)r.nodes?.a?.apply()})}function Je(t,e,n,i,s,o,a,d){var c=(a&De)!==0?(a&Re)===0?Oe(n,!1,!1):te(n):null,f=(a&He)!==0?te(s):null;return{v:c,i:f,e:W(()=>(o(e,c??n,f??s,d),()=>{t.delete(i)}))}}function L(t,e,n){if(t.nodes)for(var i=t.nodes.start,s=t.nodes.end,o=e&&(e.f&C)===0?e.nodes.start:n;i!==null;){var a=Ue(i);if(o.before(i),i===s)return;i=a}}function I(t,e,n){e===null?t.effect.first=n:e.next=n,n===null?t.effect.last=e:n.prev=e}const re=[...` 	
\r\f \v\uFEFF`];function Ve(t,e,n){var i=t==null?"":""+t;if(e&&(i=i?i+" "+e:e),n){for(var s of Object.keys(n))if(n[s])i=i?i+" "+s:s;else if(i.length)for(var o=s.length,a=0;(a=i.indexOf(s,a))>=0;){var d=a+o;(a===0||re.includes(i[a-1]))&&(d===i.length||re.includes(i[d]))?i=(a===0?"":i.substring(0,a))+i.substring(d+1):a=d}}return i===""?null:i}function dt(t,e){return t==null?null:String(t)}function ft(t,e,n,i,s,o){var a=t.__className;if(k||a!==n||a===void 0){var d=Ve(n,i,o);(!k||d!==t.getAttribute("class"))&&(d==null?t.removeAttribute("class"):e?t.className=d:t.setAttribute("class",d)),t.__className=n}else if(o&&s!==o)for(var c in o){var f=!!o[c];(s==null||f!==!!s[c])&&t.classList.toggle(c,f)}return o}const Ye=Symbol("is custom element"),Qe=Symbol("is html"),Xe=de?"link":"LINK",Ze=de?"progress":"PROGRESS";function ht(t){if(k){var e=!1,n=()=>{if(!e){if(e=!0,t.hasAttribute("value")){var i=t.value;se(t,"value",null),t.value=i}if(t.hasAttribute("checked")){var s=t.checked;se(t,"checked",null),t.checked=s}}};t.__on_r=n,ue(n),ze()}}function pt(t,e){var n=Y(t);n.value===(n.value=e??void 0)||t.value===e&&(e!==0||t.nodeName!==Ze)||(t.value=e??"")}function vt(t,e){var n=Y(t);n.checked!==(n.checked=e??void 0)&&(t.checked=e)}function se(t,e,n,i){var s=Y(t);k&&(s[e]=t.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&t.nodeName===Xe)||s[e]!==(s[e]=n)&&(e==="loading"&&(t[$e]=n),n==null?t.removeAttribute(e):typeof n!="string"&&et(t).includes(e)?t[e]=n:t.setAttribute(e,n))}function Y(t){return t.__attributes??={[Ye]:t.nodeName.includes("-"),[Qe]:t.namespaceURI===qe}}var ae=new Map;function et(t){var e=t.getAttribute("is")||t.nodeName,n=ae.get(e);if(n)return n;ae.set(e,n=[]);for(var i,s=t,o=Element.prototype;o!==s;){i=Ke(s);for(var a in i)i[a].set&&n.push(a);s=Ge(s)}return n}class tt{ws=null;url="";token="";pendingRequests=new Map;eventHandlers=new Map;reconnectTimer=null;reconnectAttempt=0;tickTimer=null;tickIntervalMs=3e4;intentionalDisconnect=!1;reqCounter=0;connectNonce=null;connectSent=!1;connectFallbackTimer=null;connectionState={status:"disconnected"};stateChangeCallbacks=new Set;reconnectConfig={initialMs:1e3,maxMs:3e4,factor:2,jitter:.1,maxAttempts:0};constructor(){}connect(e,n){this.url=e,this.token=n,this.intentionalDisconnect=!1,this.reconnectAttempt=0,this.doConnect()}disconnect(){this.intentionalDisconnect=!0,this.clearTimers(),this.ws&&(this.ws.close(1e3,"client disconnect"),this.ws=null),this.updateState({status:"disconnected"})}get connected(){return this.connectionState.status==="connected"}async call(e,n){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("Not connected");const i=`req-${++this.reqCounter}-${Date.now()}`,s={type:"req",id:i,method:e,params:n};return new Promise((o,a)=>{const d=setTimeout(()=>{this.pendingRequests.delete(i),a(new Error(`Request ${e} timed out`))},3e4);this.pendingRequests.set(i,{resolve:o,reject:a,timeout:d}),this.ws.send(JSON.stringify(s))})}on(e,n){return this.eventHandlers.has(e)||this.eventHandlers.set(e,new Set),this.eventHandlers.get(e).add(n),()=>this.off(e,n)}off(e,n){this.eventHandlers.get(e)?.delete(n)}onStateChange(e){return this.stateChangeCallbacks.add(e),()=>this.stateChangeCallbacks.delete(e)}async chatSend(e,n,i){const s=i?.idempotencyKey??crypto.randomUUID(),o={sessionKey:e,message:n,idempotencyKey:s,deliver:!1};return i?.attachments?.length&&(o.attachments=i.attachments),this.call("chat.send",o)}async chatHistory(e,n){const i=await this.call("chat.history",{sessionKey:e,limit:n??500});return i.messages??i.transcript??[]}async chatAbort(e,n){await this.call("chat.abort",{sessionKey:e,runId:n})}async sessionsList(e){const n=await this.call("sessions.list",{limit:e?.limit??50,includeDerivedTitles:e?.includeDerivedTitles??!0,includeLastMessage:e?.includeLastMessage??!0,activeMinutes:e?.activeMinutes});return n.sessions??n.list??[]}doConnect(){this.ws&&(this.ws.close(),this.ws=null),this.updateState({status:"connecting"});try{this.ws=new WebSocket(this.url)}catch(e){this.updateState({status:"error",error:`Failed to create WebSocket: ${e}`}),this.scheduleReconnect();return}this.ws.onopen=()=>{this.connectNonce=null,this.connectSent=!1,this.updateState({status:"authenticating"}),this.connectFallbackTimer&&clearTimeout(this.connectFallbackTimer),this.connectFallbackTimer=setTimeout(()=>{this.connectFallbackTimer=null,this.sendConnect()},750)},this.ws.onmessage=e=>{try{const n=JSON.parse(e.data);this.handleFrame(n)}catch{}},this.ws.onerror=()=>{},this.ws.onclose=e=>{if(this.clearTimers(),e.code===1008&&e.reason?.includes("pairing")){this.updateState({status:"error",error:"Device pairing required. Run: openclaw devices approve <requestId>"});return}this.intentionalDisconnect||(this.updateState({status:"disconnected",error:e.reason||void 0}),this.scheduleReconnect())}}handleFrame(e){e.type==="res"?this.handleResponse(e):e.type==="event"&&this.handleEvent(e)}handleResponse(e){const n=this.pendingRequests.get(e.id);if(n){clearTimeout(n.timeout),this.pendingRequests.delete(e.id),e.ok?n.resolve(e.payload??{}):n.reject(new Error(e.error?.message??"Unknown error"));return}if(e.id==="connect"){if(e.ok&&e.payload&&typeof e.payload=="object"&&"type"in e.payload){const i=e.payload;i.type==="hello-ok"&&this.handleHelloOk(i)}else if(!e.ok){const i=e.error?.message||"Connection rejected",s=i.toLowerCase().includes("pair")||e.error?.code==="PAIRING_REQUIRED"||e.error?.code==="AUTH_REQUIRED";this.updateState({status:"error",error:s?"Device pairing required — waiting for gateway owner to approve this device":i}),s&&(this.reconnectAttempt=5)}return}if(e.ok&&e.payload&&typeof e.payload=="object"&&"type"in e.payload){const i=e.payload;i.type==="hello-ok"&&this.handleHelloOk(i)}}handleEvent(e){if(e.event==="connect.challenge"){const n=e.payload;this.connectNonce=n?.nonce??null,this.connectSent=!1,this.connectFallbackTimer&&(clearTimeout(this.connectFallbackTimer),this.connectFallbackTimer=null),this.sendConnect();return}else if(e.event==="tick")this.sendTick();else{const n=this.eventHandlers.get(e.event);if(n)for(const i of n)try{i(e.payload)}catch{}}}async sendConnect(){if(this.connectSent)return;this.connectSent=!0;const e="operator",n=["operator.admin","operator.approvals","operator.pairing"];let i=this.token==="__device_auth__"?"":this.token,s;if(typeof crypto<"u"&&!!crypto.subtle)try{const{loadOrCreateDeviceIdentity:d,signDevicePayload:c,buildDeviceAuthPayload:f,loadDeviceAuthToken:l}=await ne(async()=>{const{loadOrCreateDeviceIdentity:u,signDevicePayload:E,buildDeviceAuthPayload:A,loadDeviceAuthToken:w}=await import("./B5Fyld5U.js");return{loadOrCreateDeviceIdentity:u,signDevicePayload:E,buildDeviceAuthPayload:A,loadDeviceAuthToken:w}},[],import.meta.url),v=await d(),h=l(v.deviceId,e);h&&(i=h);const p=Date.now(),T=this.connectNonce??void 0,b=f({deviceId:v.deviceId,clientId:"openclaw-control-ui",clientMode:"webchat",role:e,scopes:n,signedAtMs:p,token:i||null,nonce:T}),r=await c(v.privateKey,b);s={id:v.deviceId,publicKey:v.publicKey,signature:r,signedAt:p,nonce:T}}catch{}const a={type:"req",id:"connect",method:"connect",params:{minProtocol:3,maxProtocol:3,client:{id:"openclaw-control-ui",displayName:"Cortex",version:"1.1.0",platform:navigator.platform||"web",mode:"webchat"},role:e,scopes:n,device:s,auth:i?{token:i}:void 0,userAgent:navigator.userAgent,locale:navigator.language}};this.ws?.send(JSON.stringify(a))}handleHelloOk(e){this.reconnectAttempt=0,this.tickIntervalMs=e.policy.tickIntervalMs;const n=e;n.auth?.deviceToken&&typeof crypto<"u"&&crypto.subtle&&ne(async()=>{const{loadOrCreateDeviceIdentity:s,storeDeviceAuthToken:o}=await import("./B5Fyld5U.js");return{loadOrCreateDeviceIdentity:s,storeDeviceAuthToken:o}},[],import.meta.url).then(({loadOrCreateDeviceIdentity:s,storeDeviceAuthToken:o})=>{s().then(a=>{o({deviceId:a.deviceId,role:n.auth.role??"operator",token:n.auth.deviceToken,scopes:n.auth.scopes??[]})})}).catch(()=>{}),this.updateState({status:"connected",serverVersion:e.server.version,protocol:e.protocol,connId:e.server.connId,mainSessionKey:e.snapshot.sessionDefaults?.mainSessionKey,error:void 0}),this.startTickTimer();const i=this.eventHandlers.get("hello");if(i)for(const s of i)try{s(e)}catch{}}sendTick(){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"req",id:`tick-${Date.now()}`,method:"tick"}))}startTickTimer(){this.tickTimer&&clearInterval(this.tickTimer),this.tickTimer=setInterval(()=>this.sendTick(),this.tickIntervalMs)}scheduleReconnect(){if(this.intentionalDisconnect)return;if(this.reconnectConfig.maxAttempts>0&&this.reconnectAttempt>=this.reconnectConfig.maxAttempts){this.updateState({status:"error",error:"Max reconnection attempts reached"});return}const e=Math.min(this.reconnectConfig.initialMs*Math.pow(this.reconnectConfig.factor,this.reconnectAttempt),this.reconnectConfig.maxMs),n=e*this.reconnectConfig.jitter*(Math.random()*2-1),i=Math.max(0,e+n);this.reconnectAttempt++,this.reconnectTimer=setTimeout(()=>this.doConnect(),i)}clearTimers(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.tickTimer&&(clearInterval(this.tickTimer),this.tickTimer=null),this.connectFallbackTimer&&(clearTimeout(this.connectFallbackTimer),this.connectFallbackTimer=null)}updateState(e){this.connectionState={...this.connectionState,...e};for(const n of this.stateChangeCallbacks)try{n(this.connectionState)}catch{}}}const P=new tt,j={gateway:{url:"",ws:""},branding:{title:"Cortex",subtitle:"OpenClaw Command Center"}};let y=null;async function gt(){if(y)return y;try{const t=await fetch("/__control__/bootstrap.json",{cache:"no-store"});if(!t.ok)return console.warn(`[config] /__control__/bootstrap.json returned ${t.status}, using defaults`),y={...j},y;const e=await t.json();if(y={gateway:{url:e?.basePath||"",ws:""},branding:{title:e?.assistantName||j.branding.title,subtitle:"OpenClaw Command Center"}},typeof window<"u"&&!y.gateway.ws){const i=window.location.protocol==="https:"?"wss:":"ws:";y.gateway.ws=`${i}//${window.location.host}`}return y}catch(t){return console.warn("[config] Failed to load /__control__/bootstrap.json:",t),y={...j},y}}function nt(){return y?.gateway?.ws||""}const Q="cortex:gatewayUrl",X="cortex:gatewayToken";let U=q(je({status:"disconnected"})),O=q(""),H=q(""),J=q(!1);P.onStateChange(t=>{m(U,t,!0)});function fe(){if(typeof window>"u")return{url:"",token:""};const t=localStorage.getItem(Q)||"",e=localStorage.getItem(X)||"";return{url:t,token:e}}function it(){return nt()}function he(t,e){typeof window>"u"||(localStorage.setItem(Q,t),localStorage.setItem(X,e))}function pe(t){try{const e=new URL(t);return e.protocol==="ws:"||e.protocol==="wss:"}catch{return!1}}function ve(t){return t.trim()==="__device_auth__"?!0:/^[a-f0-9]{32,128}$/i.test(t.trim())}function ge(t,e){const n=(t??S(O)).trim(),i=(e??S(H)).trim();if(!(!n||!i)){if(!pe(n)){m(U,{status:"error",error:"Invalid gateway URL. Must start with ws:// or wss://"},!0);return}if(!ve(i)){m(U,{status:"error",error:"Invalid token format. Expected hex string."},!0);return}m(O,n,!0),m(H,i,!0),he(n,i),P.connect(n,i)}}function rt(){typeof window>"u"||(localStorage.removeItem(Q),localStorage.removeItem(X),m(O,""),m(H,""))}function st(){P.disconnect()}function at(){if(S(J))return;m(J,!0);const{url:t,token:e}=fe();m(O,t,!0),m(H,e,!0),t&&e&&ge(t,e)}function wt(){return{get state(){return S(U)},get url(){return S(O)},set url(t){m(O,t,!0)},get token(){return S(H)},set token(t){m(H,t,!0)},get initialized(){return S(J)},connect:ge,disconnect:st,init:at,saveSettings:he,loadSettings:fe,clearCredentials:rt,validateUrl:pe,validateToken:ve,getConfiguredWsUrl:it,onStateChange:P.onStateChange.bind(P)}}export{P as a,se as b,pt as c,vt as d,ut as e,wt as g,lt as i,gt as l,ht as r,ft as s,dt as t};
