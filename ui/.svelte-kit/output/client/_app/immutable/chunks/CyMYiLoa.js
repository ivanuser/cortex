import{H as A,Y as _,s as y,a as T,g as o,d as e}from"./qR_TM3YX.js";import{B as E}from"./DpBBTLWw.js";import{a as k}from"./BhtVncI_.js";import{g as $}from"./Be_uRYmX.js";function N(i,l,...a){var g=new E(i);A(()=>{const t=l()??null;g.ensure(t,t&&(r=>t(r,...a)))},_)}const w=$();function b(i){let l="",a;const g=[],t=[],r=[];if(typeof i=="string")return{text:i,toolCalls:g,toolResults:t,images:r};if(Array.isArray(i)){const s=[];for(const u of i)if(typeof u=="string")s.push(u);else if(u&&typeof u=="object"){const n=u;if(n.type==="text"&&typeof n.text=="string")s.push(n.text);else if(n.type==="thinking"&&typeof n.thinking=="string")a=n.thinking;else if(n.type==="image"){const R=n.source;if(R&&R.type==="base64"&&typeof R.data=="string"){const v=R.media_type||"image/png";r.push({mimeType:v,dataUrl:`data:${v};base64,${R.data}`})}else typeof n.url=="string"&&r.push({mimeType:n.mimeType||"image/png",dataUrl:n.url})}else n.type==="toolCall"||n.type==="tool_use"?g.push({id:n.id,name:n.name,arguments:n.arguments||n.input}):(n.type==="toolResult"||n.type==="tool_result")&&t.push({toolCallId:n.toolCallId,name:n.toolName||n.name,content:typeof n.content=="string"?n.content:JSON.stringify(n.content),isError:n.isError||!1})}l=s.filter(Boolean).join(`
`)}else if(i&&typeof i=="object"){const s=i;typeof s.text=="string"&&(l=s.text)}return{text:l,thinkingContent:a,toolCalls:g,toolResults:t,images:r}}let h=y(T([])),p=y(!1),f=y(""),d=y(""),c=y(T([])),m=y(null),C=y(""),x=y(!1);k.on("chat",i=>{const l=i;if(l.sessionKey===o(C))switch(l.state){case"delta":{if(e(p,!0),e(m,l.runId,!0),l.message?.content){const a=b(l.message.content);a.text&&e(f,o(f)+a.text),a.thinkingContent&&e(d,a.thinkingContent,!0),a.toolCalls.length&&e(c,[...o(c),...a.toolCalls],!0)}break}case"final":{const a=l.message?.content?b(l.message.content):null,g=a?.text||o(f),t=a?.thinkingContent||o(d)||void 0;(g||t||a?.toolCalls?.length||a?.toolResults?.length||o(c).length)&&e(h,[...o(h),{id:`msg-${Date.now()}-${l.seq}`,role:"assistant",content:g,timestamp:Date.now(),thinkingContent:t,toolCalls:a?.toolCalls?.length?a.toolCalls:o(c).length?o(c):l.message?.toolCalls,toolResults:a?.toolResults?.length?a.toolResults:l.message?.toolResults}],!0),e(f,""),e(d,""),e(c,[],!0),e(p,!1),e(m,null);break}case"aborted":{(o(f)||o(d)||o(c).length)&&e(h,[...o(h),{id:`msg-${Date.now()}-aborted`,role:"assistant",content:o(f),timestamp:Date.now(),thinkingContent:o(d)||void 0,toolCalls:o(c).length?o(c):void 0,isAborted:!0}],!0),e(f,""),e(d,""),e(c,[],!0),e(p,!1),e(m,null);break}case"error":{(o(f)||o(d)||o(c).length)&&e(h,[...o(h),{id:`msg-${Date.now()}-err`,role:"assistant",content:o(f),timestamp:Date.now(),thinkingContent:o(d)||void 0,toolCalls:o(c).length?o(c):void 0,isError:!0}],!0),w.error("Chat Error",l.errorMessage||"Failed to generate response"),e(f,""),e(d,""),e(c,[],!0),e(p,!1),e(m,null);break}}});async function D(i){if(e(C,i,!0),e(x,!0),e(h,[],!0),e(f,""),e(d,""),e(c,[],!0),e(p,!1),e(m,null),!k.connected){e(x,!1);return}try{const a=(await k.chatHistory(i,1e3)).map((t,r)=>{const s=b(t.content);return{index:r,role:t.role,content:s.text,timestamp:t.ts?t.ts*1e3:Date.now(),channel:t.channel,images:s.images,thinkingContent:s.thinkingContent,toolCalls:s.toolCalls?.length?s.toolCalls:t.toolCalls??[],toolResults:s.toolResults?.length?s.toolResults:t.toolResults??[],rawContent:t.content}}),g=new Map;for(const t of a){for(const r of t.toolResults)r.toolCallId&&g.set(r.toolCallId,r);if(Array.isArray(t.rawContent)){for(const r of t.rawContent)if(r&&typeof r=="object"){const s=r;if((s.type==="tool_result"||s.type==="toolResult")&&typeof s.tool_use_id=="string"){const u=typeof s.content=="string"?s.content:Array.isArray(s.content)?s.content.filter(n=>n?.type==="text").map(n=>n.text).join(`
`):JSON.stringify(s.content);g.set(s.tool_use_id,{toolCallId:s.tool_use_id,content:u,isError:s.is_error||!1})}}}}e(h,a.filter(t=>t.role==="user"||t.role==="assistant").map(t=>{const r=[];for(const u of t.toolCalls){const n=g.get(u.id);n&&r.push(n)}const s=r.length?r:t.toolResults.length?t.toolResults:void 0;return{id:`hist-${t.index}-${t.timestamp}`,role:t.role,content:t.content,timestamp:t.timestamp,channel:t.channel,images:t.images.length?t.images:void 0,thinkingContent:t.thinkingContent,toolCalls:t.toolCalls.length?t.toolCalls:void 0,toolResults:s,isHistorical:!0}}).filter(t=>t.content.trim()!==""||t.thinkingContent||t.toolCalls?.length||t.toolResults?.length||t.images?.length),!0)}catch(l){console.error("Failed to load chat history:",l),w.error("History Load Failed",l instanceof Error?l.message:"Could not load chat history")}finally{e(x,!1)}}async function I(i,l){const a=i.trim().length>0,g=l&&l.length>0;if(!(!a&&!g||!o(C)||!k.connected)){e(h,[...o(h),{id:`msg-${Date.now()}-user`,role:"user",content:i,timestamp:Date.now(),images:g?l:void 0}],!0),e(p,!0),e(f,""),e(d,""),e(c,[],!0);try{const t=g?l.map(s=>{const u=/^data:([^;]+);base64,(.+)$/.exec(s.dataUrl);return u?{type:"image",mimeType:u[1],content:u[2]}:null}).filter(s=>s!==null):void 0,r=await k.chatSend(o(C),i,{attachments:t});e(m,r.runId,!0)}catch(t){e(p,!1),console.error("Failed to send message:",t),w.error("Send Failed",t instanceof Error?t.message:"Could not send message")}}}async function F(){if(o(C))try{await k.chatAbort(o(C),o(m)??void 0)}catch(i){console.error("Failed to abort:",i)}}function B(){return{get list(){return o(h)},get streaming(){return o(p)},get streamingContent(){return o(f)},get streamingThinkingContent(){return o(d)},get streamingToolCalls(){return o(c)},get activeRunId(){return o(m)},get loadingHistory(){return o(x)},get activeSessionKey(){return o(C)},loadHistory:D,sendMessage:I,abortResponse:F}}export{B as g,N as s};
