const tt={p:0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffedn,n:0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3edn,h:8n,a:0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffecn,d:0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3n,Gx:0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51an,Gy:0x6666666666666666666666666666666666666666666666666666666666666658n},{p:h,n:k,Gx:j,Gy:$,a:O,d:R,h:wt}=tt,I=32,L=64,xt=(...t)=>{"captureStackTrace"in Error&&typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(...t)},l=(t="")=>{const n=new Error(t);throw xt(n,l),n},St=t=>typeof t=="bigint",It=t=>typeof t=="string",Kt=t=>t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array",x=(t,n,e="")=>{const o=Kt(t),c=t?.length,s=n!==void 0;if(!o||s&&c!==n){const i=e&&`"${e}" `,a=s?` of length ${n}`:"",f=o?`length=${c}`:`type=${typeof t}`;l(i+"expected Uint8Array"+a+", got "+f)}return t},X=t=>new Uint8Array(t),nt=t=>Uint8Array.from(t),et=(t,n)=>t.toString(16).padStart(n,"0"),ot=t=>Array.from(x(t)).map(n=>et(n,2)).join(""),w={_0:48,_9:57,A:65,F:70,a:97,f:102},J=t=>{if(t>=w._0&&t<=w._9)return t-w._0;if(t>=w.A&&t<=w.F)return t-(w.A-10);if(t>=w.a&&t<=w.f)return t-(w.a-10)},st=t=>{const n="hex invalid";if(!It(t))return l(n);const e=t.length,o=e/2;if(e%2)return l(n);const c=X(o);for(let s=0,i=0;s<o;s++,i+=2){const a=J(t.charCodeAt(i)),f=J(t.charCodeAt(i+1));if(a===void 0||f===void 0)return l(n);c[s]=a*16+f}return c},ct=()=>globalThis?.crypto,Tt=()=>ct()?.subtle??l("crypto.subtle must be defined, consider polyfill"),B=(...t)=>{const n=X(t.reduce((o,c)=>o+x(c).length,0));let e=0;return t.forEach(o=>{n.set(o,e),e+=o.length}),n},mt=(t=I)=>ct().getRandomValues(X(t)),_=BigInt,S=(t,n,e,o="bad number: out of range")=>St(t)&&n<=t&&t<e?t:l(o),r=(t,n=h)=>{const e=t%n;return e>=0n?e:n+e},rt=t=>r(t,k),Et=(t,n)=>{(t===0n||n<=0n)&&l("no inverse n="+t+" mod="+n);let e=r(t,n),o=n,c=0n,s=1n;for(;e!==0n;){const i=o/e,a=o%e,f=c-s*i;o=e,e=a,c=s,s=f}return o===1n?r(c,n):l("no inverse")},Bt=t=>{const n=dt[t];return typeof n!="function"&&l("hashes."+t+" not set"),n},C=t=>t instanceof b?t:l("Point expected"),U=2n**256n;class b{static BASE;static ZERO;X;Y;Z;T;constructor(n,e,o,c){const s=U;this.X=S(n,0n,s),this.Y=S(e,0n,s),this.Z=S(o,1n,s),this.T=S(c,0n,s),Object.freeze(this)}static CURVE(){return tt}static fromAffine(n){return new b(n.x,n.y,1n,r(n.x*n.y))}static fromBytes(n,e=!1){const o=R,c=nt(x(n,I)),s=n[31];c[31]=s&-129;const i=ft(c);S(i,0n,e?U:h);const f=r(i*i),d=r(f-1n),u=r(o*f+1n);let{isValid:y,value:p}=kt(d,u);y||l("bad point: y not sqrt");const g=(p&1n)===1n,v=(s&128)!==0;return!e&&p===0n&&v&&l("bad point: x==0, isLastByteOdd"),v!==g&&(p=r(-p)),new b(p,i,1n,r(p*i))}static fromHex(n,e){return b.fromBytes(st(n),e)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}assertValidity(){const n=O,e=R,o=this;if(o.is0())return l("bad point: ZERO");const{X:c,Y:s,Z:i,T:a}=o,f=r(c*c),d=r(s*s),u=r(i*i),y=r(u*u),p=r(f*n),g=r(u*r(p+d)),v=r(y+r(e*r(f*d)));if(g!==v)return l("bad point: equation left != right (1)");const T=r(c*s),m=r(i*a);return T!==m?l("bad point: equation left != right (2)"):this}equals(n){const{X:e,Y:o,Z:c}=this,{X:s,Y:i,Z:a}=C(n),f=r(e*a),d=r(s*c),u=r(o*a),y=r(i*c);return f===d&&u===y}is0(){return this.equals(E)}negate(){return new b(r(-this.X),this.Y,this.Z,r(-this.T))}double(){const{X:n,Y:e,Z:o}=this,c=O,s=r(n*n),i=r(e*e),a=r(2n*r(o*o)),f=r(c*s),d=n+e,u=r(r(d*d)-s-i),y=f+i,p=y-a,g=f-i,v=r(u*p),T=r(y*g),m=r(u*g),Z=r(p*y);return new b(v,T,Z,m)}add(n){const{X:e,Y:o,Z:c,T:s}=this,{X:i,Y:a,Z:f,T:d}=C(n),u=O,y=R,p=r(e*i),g=r(o*a),v=r(s*y*d),T=r(c*f),m=r((e+o)*(i+a)-p-g),Z=r(T-v),V=r(T+v),P=r(g-u*p),bt=r(m*Z),gt=r(V*P),vt=r(m*P),At=r(Z*V);return new b(bt,gt,At,vt)}subtract(n){return this.add(C(n).negate())}multiply(n,e=!0){if(!e&&(n===0n||this.is0()))return E;if(S(n,1n,k),n===1n)return this;if(this.equals(K))return Ht(n).p;let o=E,c=K;for(let s=this;n>0n;s=s.double(),n>>=1n)n&1n?o=o.add(s):e&&(c=c.add(s));return o}multiplyUnsafe(n){return this.multiply(n,!1)}toAffine(){const{X:n,Y:e,Z:o}=this;if(this.equals(E))return{x:0n,y:1n};const c=Et(o,h);r(o*c)!==1n&&l("invalid inverse");const s=r(n*c),i=r(e*c);return{x:s,y:i}}toBytes(){const{x:n,y:e}=this.assertValidity().toAffine(),o=it(e);return o[31]|=n&1n?128:0,o}toHex(){return ot(this.toBytes())}clearCofactor(){return this.multiply(_(wt),!1)}isSmallOrder(){return this.clearCofactor().is0()}isTorsionFree(){let n=this.multiply(k/2n,!1).double();return k%2n&&(n=n.add(this)),n.is0()}}const K=new b(j,$,1n,r(j*$)),E=new b(0n,1n,1n,0n);b.BASE=K;b.ZERO=E;const it=t=>st(et(S(t,0n,U),L)).reverse(),ft=t=>_("0x"+ot(nt(x(t)).reverse())),A=(t,n)=>{let e=t;for(;n-- >0n;)e*=e,e%=h;return e},Zt=t=>{const e=t*t%h*t%h,o=A(e,2n)*e%h,c=A(o,1n)*t%h,s=A(c,5n)*c%h,i=A(s,10n)*s%h,a=A(i,20n)*i%h,f=A(a,40n)*a%h,d=A(f,80n)*f%h,u=A(d,80n)*f%h,y=A(u,10n)*s%h;return{pow_p_5_8:A(y,2n)*t%h,b2:e}},z=0x2b8324804fc1df0b2b4d00993dfbd7a72f431806ad2fe478c4ee1b274a0ea0b0n,kt=(t,n)=>{const e=r(n*n*n),o=r(e*e*n),c=Zt(t*o).pow_p_5_8;let s=r(t*e*c);const i=r(n*s*s),a=s,f=r(s*z),d=i===t,u=i===r(-t),y=i===r(-t*z);return d&&(s=a),(u||y)&&(s=f),(r(s)&1n)===1n&&(s=r(-s)),{isValid:d||u,value:s}},D=t=>rt(ft(t)),q=(...t)=>dt.sha512Async(B(...t)),_t=(...t)=>Bt("sha512")(B(...t)),at=t=>{const n=t.slice(0,I);n[0]&=248,n[31]&=127,n[31]|=64;const e=t.slice(I,L),o=D(n),c=K.multiply(o),s=c.toBytes();return{head:n,prefix:e,scalar:o,point:c,pointBytes:s}},F=t=>q(x(t,I)).then(at),Yt=t=>at(_t(x(t,I))),Xt=t=>F(t).then(n=>n.pointBytes),Ot=t=>q(t.hashable).then(t.finish),Rt=(t,n,e)=>{const{pointBytes:o,scalar:c}=t,s=D(n),i=K.multiply(s).toBytes();return{hashable:B(i,o,e),finish:d=>{const u=rt(s+D(d)*c);return x(B(i,it(u)),L)}}},Ct=async(t,n)=>{const e=x(t),o=await F(n),c=await q(o.prefix,e);return Ot(Rt(o,c,e))},dt={sha512Async:async t=>{const n=Tt(),e=B(t);return X(await n.digest("SHA-512",e.buffer))},sha512:void 0},Nt=(t=mt(I))=>t,Ut={getExtendedPublicKeyAsync:F,getExtendedPublicKey:Yt,randomSecretKey:Nt},Y=8,Dt=256,ut=Math.ceil(Dt/Y)+1,G=2**(Y-1),Gt=()=>{const t=[];let n=K,e=n;for(let o=0;o<ut;o++){e=n,t.push(e);for(let c=1;c<G;c++)e=e.add(n),t.push(e);n=e.double()}return t};let W;const Q=(t,n)=>{const e=n.negate();return t?e:n},Ht=t=>{const n=W||(W=Gt());let e=E,o=K;const c=2**Y,s=c,i=_(c-1),a=_(Y);for(let f=0;f<ut;f++){let d=Number(t&i);t>>=a,d>G&&(d-=s,t+=1n);const u=f*G,y=u,p=u+Math.abs(d)-1,g=f%2!==0,v=d<0;d===0?o=o.add(Q(g,n[y])):e=e.add(Q(v,n[p]))}return t!==0n&&l("invalid wnaf"),{p:e,f:o}},N="openclaw-device-identity-v1",lt="openclaw.device.auth.v1";function H(t){let n="";for(const e of t)n+=String.fromCharCode(e);return btoa(n).replaceAll("+","-").replaceAll("/","_").replace(/=+$/g,"")}function yt(t){const n=t.replaceAll("-","+").replaceAll("_","/"),e=n+"=".repeat((4-n.length%4)%4),o=atob(e),c=new Uint8Array(o.length);for(let s=0;s<o.length;s++)c[s]=o.charCodeAt(s);return c}function Lt(t){return Array.from(t).map(n=>n.toString(16).padStart(2,"0")).join("")}async function pt(t){const n=await crypto.subtle.digest("SHA-256",t.buffer);return Lt(new Uint8Array(n))}async function qt(){const t=Ut.randomSecretKey(),n=await Xt(t);return{deviceId:await pt(n),publicKey:H(n),privateKey:H(t)}}async function Ft(){try{const e=localStorage.getItem(N);if(e){const o=JSON.parse(e);if(o?.version===1&&typeof o.deviceId=="string"&&typeof o.publicKey=="string"&&typeof o.privateKey=="string"){const c=await pt(yt(o.publicKey));if(c!==o.deviceId){const s={...o,deviceId:c};return localStorage.setItem(N,JSON.stringify(s)),{deviceId:c,publicKey:o.publicKey,privateKey:o.privateKey}}return{deviceId:o.deviceId,publicKey:o.publicKey,privateKey:o.privateKey}}}}catch{}const t=await qt(),n={version:1,deviceId:t.deviceId,publicKey:t.publicKey,privateKey:t.privateKey,createdAtMs:Date.now()};return localStorage.setItem(N,JSON.stringify(n)),t}async function Mt(t,n){const e=yt(t),o=new TextEncoder().encode(n),c=await Ct(o,e);return H(c)}function Vt(t){const n=t.nonce?"v2":"v1",e=t.scopes.join(","),o=t.token??"",c=[n,t.deviceId,t.clientId,t.clientMode,t.role,e,String(t.signedAtMs),o];return n==="v2"&&c.push(t.nonce??""),c.join("|")}function M(){try{const t=localStorage.getItem(lt);if(!t)return null;const n=JSON.parse(t);return!n||n.version!==1||!n.deviceId||typeof n.deviceId!="string"||!n.tokens||typeof n.tokens!="object"?null:n}catch{return null}}function ht(t){try{localStorage.setItem(lt,JSON.stringify(t))}catch{}}function Pt(t,n){const e=M();if(!e||e.deviceId!==t)return null;const o=e.tokens[n];return!o||typeof o.token!="string"?null:o.token}function jt(t){const n={version:1,deviceId:t.deviceId,tokens:{}},e=M();e&&e.deviceId===t.deviceId&&(n.tokens={...e.tokens}),n.tokens[t.role]={token:t.token,role:t.role,scopes:t.scopes??[],updatedAtMs:Date.now()},ht(n)}function $t(t,n){const e=M();if(!e||e.deviceId!==t||!e.tokens[n])return;const o={...e,tokens:{...e.tokens}};delete o.tokens[n],ht(o)}function Jt(){return typeof crypto<"u"&&!!crypto.subtle}export{Vt as buildDeviceAuthPayload,$t as clearDeviceAuthToken,Jt as isSecureContext,Pt as loadDeviceAuthToken,Ft as loadOrCreateDeviceIdentity,Mt as signDevicePayload,jt as storeDeviceAuthToken};
